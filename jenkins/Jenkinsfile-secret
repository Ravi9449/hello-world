properties([
    parameters([
        [$class: 'StringParameterDefinition',
            name: 'Check-secret Username',
            description: 'Username for check-secret',
            defaultValue: getDefaultValue(),
        ]
    ])
])

def getDefaultValue() {
    def kubectlCmd = "kubectl get secret check-secret -o json"
    def secretData = [:]

    try {
        def proc = kubectlCmd.execute()
        def output = new StringBuilder()
        proc.waitForProcessOutput(output, System.err)

        // Parse the entire JSON output
        def json = new groovy.json.JsonSlurper().parseText(output.toString())
        // Extract the username from the secret data
        def usernameBase64 = json.data.username
        def username = new String(usernameBase64.decodeBase64())

        println "${username}"
    } catch (Exception e) {
        println("Error retrieving Kubernetes Secret: ${e.message}")
        return 'Error' // Return a default value indicating an error
    }
}

pipeline {
    agent any

    stages {
        stage('Check') {
            steps {
                script {
                    // Access the parameter value
                    def username = params['Check-secret Username']
                    echo "Selected username: ${username}"
                }
            }
        }
    }
}
