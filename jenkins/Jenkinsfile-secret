properties([
    parameters([
        [$class: 'StringParameterDefinition',
            name: 'Check-secret Username',
            description: 'Username for check-secret',
            defaultValue: getDefaultValue(),
        ]
    ])
])

def getDefaultValue() {
    def kubectlCmd = "kubectl get secret check-secret -o json"
    def secretData = [:]

    try {
        def proc = kubectlCmd.execute()
        def output = new StringBuilder()
        proc.waitForProcessOutput(output, System.err)

        // Parse the entire JSON output
        def json = new groovy.json.JsonSlurper().parseText(output.toString())
        secretData = json.data
        def username = new String(secretData.username)
        
        println "Username: ${username}"
    } catch (Exception e) {
        println "Error retrieving Kubernetes Secret: ${e.message}"
    }
}


pipeline {
    agent any

    stages {
        stage('Check') {
            steps {
                script {
                    // Access the parameter value
                    def username = params['Check-secret Username']
                    echo "Selected username: ${username}"
                }
            }
        }
    }
}
